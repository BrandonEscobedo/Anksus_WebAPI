@page "/Pregunta"
@layout ComponentsBase.ComponentBaseLogin
@inject IStateConteiner _StateContainer
<p> Pregunta: @pregunta.pregunta</p>
@foreach (var preguntas in pregunta.Respuesta!)
{
    <button type="button" @onclick="(e=> ValidarRespuesta(preguntas.IdRespuesta))" class="@preguntas.ClaseCSS">respuesta: @preguntas.respuesta</button>
}
<p>@segundos</p>
@code {
    @using System.Timers
    private PreguntasDTO pregunta = new();
    private ComponentObjectPreguntas Datospreguntas = new();
    private Timer Timer = new Timer(1000);
    private int segundos = 10;
    [Parameter]
    public EventCallback OnSiguiente { get; set; }
    [Parameter]
    public EventCallback<ComponentObjectPreguntas> OnPreguntaContestada { get; set; }
    private bool eventCallPreguntaContestada = false;
    protected override void OnInitialized()
    {
        pregunta = _StateContainer.pregunta;
        if (Timer.Enabled == false) Timer.Enabled = true;
        Timer.Elapsed += TimerEvent;
    }
    private async void ValidarRespuesta(int idrespuesta)
    {
        if (pregunta?.Respuesta?.Where(x => x.RCorrecta == true).FirstOrDefault()?.IdRespuesta == idrespuesta)
        {
            Datospreguntas.puntos = segundos * 13;
            Datospreguntas.esCorrecto = true;
        }
        await OnPreguntaContestada.InvokeAsync(Datospreguntas);
        eventCallPreguntaContestada = true;
    }
    private async void TimerEvent(object source, System.Timers.ElapsedEventArgs e)
    {
        segundos = segundos - 1;
        if (segundos == 0)
        {
            Timer.Enabled = false;
            Timer.Dispose();
            foreach (var resp in pregunta!.Respuesta!)
            {
                if (resp.RCorrecta)
                {
                    resp.ClaseCSS = "btn btn-success";
                }
            }
            if (!eventCallPreguntaContestada) await OnPreguntaContestada.InvokeAsync(Datospreguntas);

            await OnSiguiente.InvokeAsync();
        }
        StateHasChanged();
    }

}